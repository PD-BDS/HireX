route_query:
  agent: query_routing_manager
  description: |
    ## Mission
    Interpret the recruiter’s latest instruction and map it to the correct next
    crew phase sequence. Apply the minimal required flags so the workflow stays
    predictable, auditable, and aligned with both explicit recruiter intent and
    scenario-guided interpretations.

    ## Tool Usage (MANDATORY)
    - Before deciding on phases or flags you MUST call the `scenario_hint_lookup` tool EXACTLY ONCE and then proceed with your analysis.
    - Pass `user_query`, `last_phase`, `query_control`, `state`, and `conversation_history` exactly as provided.
    - If the tool returns “No close scenario match available.”, state that explicitly in your reasoning and proceed.

    ## Reasoning Protocol (Internal Only)
    Think in this sequence:
    1. Parse recruiter intent from the literal wording.
    2. Call `scenario_hint_lookup` tool ONCE; wait for response and move to step 3 - do not call tool again.
    3. Summarise and merge guidance from the tool response, or note that none was available.
    4. Identify required phases using Phase Decision Logic.
    5. Inspect state (`jd_complete`, `candidates_ready`, previous screening results).
    6. Apply flag rules (update_jd, allow_jd_incomplete, new_job_search, screen_again).
    7. Construct minimal valid phase sequence.
    8. Validate sequence respects dependency order.
    9. Produce rationale (1–2 sentences) citing recruiter request + state + scenario hint.
    10. Return your final JSON answer - you are DONE, do not use any tools at this point.

    ## Phase Decision Logic (MANDATORY)
    - job_description
        Use when:
          • recruiter is creating or refining a job description
          • recruiter is clarifying role details
          • recruiter expresses role pivot (combined with new_job_search)
          • recruiter wants adjustments after screening
        Always set update_jd=true, except during new role pivots.

    - screening
        Use when:
          • recruiter asks to screen candidates
          • recruiter asks for new screening, fresh pass, or rerun
        Always set allow_jd_incomplete=true.
        Set screen_again=true when recruiter expresses “fresh”, “rerun”, “run again”.
        Copy requested candidate count into top_k_hint (if provided).

    - discussion
        Use when:
          • recruiter wants to review candidates or outcomes
          • recruiter asks comparative questions about profiles
          • recruiter wants more detail on screening results
        Only use when candidates_ready=true OR recruiter explicitly wants to discuss results.

    ## Multi-Step Instructions
    If the recruiter expresses a sequence (e.g., “update JD then screen”):
      - Output phases in dependency order: ["job_description", "screening"]
      - Set update_jd=true and allow_jd_incomplete=true
      - Apply screen_again=true when appropriate
      - Respect any numeric candidate request (set top_k_hint)

    ## Explicit vs Ambiguous Intent (Hybrid Model C)
    - Explicit recruiter commands ALWAYS override scenario hints.
    - Ambiguous or partial requests → scenario hints assist interpretation.
    - Scenario hints supplement every decision—cite them even when they confirm the explicit request.
    - Scenario hints never override a clear recruiter instruction.

    ## Redundancy Avoidance
    - If job_description just completed and recruiter asks to screen →
      output "screening" only.
    - If screening is complete and recruiter asks to discuss →
      output "discussion" only.
    - If recruiter wants job refinement after screening →
      output "job_description" only.

    ## Flag Preservation & Omission Rules
    - Preserve true state flags (jd_complete, candidates_ready) unless contradicted.
    - Omit flags that remain false or unknown.
    - Only include flags when they MUST be present for routing coherence.
    
    ## Inputs
    - Latest recruiter turn:
      {user_query}

    - Last resolved phase:
      {last_phase}

    - Previous plan sequence:
      {previous_plan}

    - Active query routing control flags:
      {query_control}

    - Recent conversation history:
      {conversation_history}

    - Application state snapshot:
      {state}

  expected_output: |
    Emit JSON validating against `QueryRoutingOutput`.
    Shape:
      {
        "query_controls": {
          "phase_sequence": ["<phase literal>", ...]
        },
        "cleaned_user_query": "<exact recruiter message>"
      }

    Optional keys:
      - query_controls.last_completed_phase
      - query_controls.jd_complete
      - query_controls.candidates_ready
      - query_controls.allow_jd_incomplete
      - query_controls.update_jd
      - query_controls.new_job_search
      - query_controls.screen_again
      - query_controls.top_k_hint
      - reasoning

    Constraints:
      - Allow only these phases: job_description, screening, discussion.
      - Maximum of three phases in valid dependency order.
      - Always set allow_jd_incomplete=true when screening occurs.
      - For reruns: set screening + screen_again=true.
      - For role pivots: emit job_description + new_job_search=true (without update_jd).
      - For composite requests: preserve full sequence and flags.
      - Reasoning MUST mention the scenario hint outcome (either the returned guidance or that no hint was available).
      - Never emit markdown. Never hallucinate phases or flags.
