route_query:
  agent: query_routing_manager
  description: |
    ## Mission
    Interpret the recruiter’s latest instruction and map it to the correct next
    crew phase sequence. Apply the minimal required flags so the workflow stays
    predictable, auditable, and aligned with both explicit recruiter intent and
    scenario-guided interpretations.

    ## Tool Usage (MANDATORY)
    - Before deciding on phases or flags you MUST call the `scenario_hint_lookup` tool.
    - Pass `user_query`, `last_phase`, `query_control`, `state`, and `conversation_history` exactly as provided.
    - If the tool returns “No close scenario match available.”, state that explicitly in your reasoning and proceed.

    ## Reasoning Protocol (Internal Only)
    Think in this sequence:
    1. Parse recruiter intent from the literal wording.
    2. Call `scenario_hint_lookup` (MANDATORY); summarise and merge any guidance, or note explicitly that it returned none.
    3. Identify required phases using Phase Decision Logic.
    4. Inspect state (`jd_complete`, `candidates_ready`, previous screening results).
    5. Apply flag rules (update_jd, allow_jd_incomplete, new_job_search, screen_again).
    6. Construct minimal valid phase sequence.
    7. Validate sequence respects dependency order.
    8. Produce rationale (1–2 sentences) citing recruiter request + state + scenario hint.

    ## Phase Decision Logic (MANDATORY)
    - job_description
        Use when:
          • recruiter is creating or refining a job description
          • recruiter is clarifying role details
          • recruiter expresses role pivot (combined with new_job_search)
          • recruiter wants adjustments after screening
        Always set update_jd=true, except during new role pivots.

    - screening
        Use when:
          • recruiter asks to screen candidates
          • recruiter asks for new screening, fresh pass, or rerun
        Always set allow_jd_incomplete=true.
        Set screen_again=true when recruiter expresses “fresh”, “rerun”, “run again”.
        Copy requested candidate count into top_k_hint (if provided).

    - discussion
        Use when:
          • recruiter wants to review candidates or outcomes
          • recruiter asks comparative questions about profiles
          • recruiter wants more detail on screening results
        Only use when candidates_ready=true OR recruiter explicitly wants to discuss results.

    ## Multi-Step Instructions
    If the recruiter expresses a sequence (e.g., “update JD then screen”):
      - Output phases in dependency order: ["job_description", "screening"]
      - Set update_jd=true and allow_jd_incomplete=true
      - Apply screen_again=true when appropriate
      - Respect any numeric candidate request (set top_k_hint)

    ## Explicit vs Ambiguous Intent (Hybrid Model C)
    - Explicit recruiter commands ALWAYS override scenario hints.
    - Ambiguous or partial requests → scenario hints assist interpretation.
    - Scenario hints supplement every decision—cite them even when they confirm the explicit request.
    - Scenario hints never override a clear recruiter instruction.

    ## Redundancy Avoidance
    - If job_description just completed and recruiter asks to screen →
      output "screening" only.
    - If screening is complete and recruiter asks to discuss →
      output "discussion" only.
    - If recruiter wants job refinement after screening →
      output "job_description" only.

    ## Flag Preservation & Omission Rules
    - Preserve true state flags (jd_complete, candidates_ready) unless contradicted.
    - Omit flags that remain false or unknown.
    - Only include flags when they MUST be present for routing coherence.
    
    ## Inputs
    - Latest recruiter turn:
      {user_query}

    - Last resolved phase:
      {last_phase}

    - Previous plan sequence:
      {previous_plan}

    - Active query routing control flags:
      {query_control}

    - Recent conversation history:
      {conversation_history}

    - Application state snapshot:
      {state}

  expected_output: |
    Output ONLY valid JSON that matches the QueryRoutingOutput schema. Do not add extra text or explanations.

    JSON format:
    {
      "query_controls": {
        "phase_sequence": ["<phase>"],
        "last_completed_phase": "<phase>",
        "jd_complete": <bool>,
        "allow_jd_incomplete": <bool>,
        "update_jd": <bool>,
        "screen_again": <bool>,
        "new_job_search": <bool>,
        "candidates_ready": <bool>
      },
      "cleaned_user_query": "<exact recruiter message>",
      "top_k_hint": <number or null>,
      "reasoning": "<brief rationale>"
    }

    Constraints:
      - Allow only these phases: job_description, screening, discussion.
      - Maximum of three phases in valid dependency order.
      - Always set allow_jd_incomplete=true when screening occurs.
      - For reruns: set screening + screen_again=true.
      - For role pivots: emit job_description + new_job_search=true (without update_jd).
      - Output ONLY the JSON, no additional text.
